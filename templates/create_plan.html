{% extends "base.html" %}

{% block title %}AI-–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ - Instagram Auto Post Tool V3{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ü§ñ AI-–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</h1>
    <p class="page-subtitle">–°–æ–∑–¥–∞–π—Ç–µ –ø–ª–∞–Ω –ø—É–±–ª–∏–∫–∞—Ü–∏–π —Å –ø–æ–º–æ—â—å—é –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞</p>
</div>

<div class="card">
    <h2 class="card-title">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è AI</h2>
    <p style="color: var(--text-secondary); margin-bottom: 20px;">
        –û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å—Ç–∏—Ç—å –∏ AI —Å–æ–∑–¥–∞—Å—Ç –ø–æ–ª–Ω—ã–π –ø–ª–∞–Ω –ø—É–±–ª–∏–∫–∞—Ü–∏–π
    </p>
    
    <div class="form-group">
        <label class="form-label">–ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π:</label>
        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; line-height: 1.8;">
            <div>üìå –ü–æ—Å—Ç–∏—Ç—å –ø—Ä–æ —Å–ø–æ—Ä—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º –Ω–∞ @sportblog_kz –∏ @fitness_astana</div>
            <div>üìå –î–µ–ª–∞—Ç—å –ø–æ 5 –ø–æ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å –Ω–∞ –∫–∞–∂–¥–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ</div>
            <div>üìå –§–æ—Ä–º–∞—Ç: —Ñ–æ—Ç–æ</div>
            <br>
            <div>üìå –ü–æ—Å—Ç–∏—Ç—å –ø—Ä–æ –º—É–∑—ã–∫—É –Ω–∞ –∫–∞–∑–∞—Ö—Å–∫–æ–º –Ω–∞ @music_almaty</div>
            <div>üìå 3 –ø–æ—Å—Ç–∞ –≤ –¥–µ–Ω—å, —Ñ–æ—Ä–º–∞—Ç –≤–∏–¥–µ–æ</div>
        </div>
        
        <textarea 
            class="form-textarea" 
            id="instruction" 
            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∑–¥–µ—Å—å..."
            style="min-height: 200px;"
        ></textarea>
    </div>
    
    <button class="btn btn-primary" onclick="createPlan()" style="width: 100%;">
        ü§ñ –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω —Å AI
    </button>
</div>

<div id="planPreview" style="display: none;">
    <div class="card">
        <h2 class="card-title">üìã –ü–ª–∞–Ω —Å–æ–∑–¥–∞–Ω</h2>
        <div id="planContent"></div>
        
        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button class="btn btn-success" onclick="generatePosts()" style="flex: 1;" id="generateBtn">
                üöÄ –ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
            </button>
            <button class="btn btn-secondary" onclick="editPlan()">
                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>
    </div>
</div>

<div id="generationProgress" style="display: none;">
    <div class="card">
        <h2 class="card-title">üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤...</h2>
        
        <div style="margin: 20px 0;">
            <div style="background: var(--bg-tertiary); height: 8px; border-radius: 4px; overflow: hidden;">
                <div id="progressBar" style="background: var(--accent); height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <div style="text-align: center; margin-top: 12px; color: var(--text-secondary);" id="progressText">
                –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...
            </div>
        </div>
        
        <div id="progressDetails" style="font-family: monospace; font-size: 13px; max-height: 200px; overflow-y: auto; background: var(--bg-primary); padding: 12px; border-radius: 8px;"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPlan = null;
    
    async function createPlan() {
        const instruction = document.getElementById('instruction').value.trim();
        
        if (!instruction) {
            showToast('–í–≤–µ–¥–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é', 'error');
            return;
        }
        
        showLoading();
        
        try {
            const data = await apiRequest('/api/ai/create-plan', {
                method: 'POST',
                body: JSON.stringify({ instruction })
            });
            
            currentPlan = data.plan;
            displayPlan(currentPlan);
            showToast('–ü–ª–∞–Ω —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
            
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    function displayPlan(plan) {
        const preview = document.getElementById('planPreview');
        const content = document.getElementById('planContent');
        
        let html = '<div style="border: 2px solid var(--accent); border-radius: 8px; padding: 20px; background: var(--bg-primary);">';
        
        plan.accounts.forEach(acc => {
            html += `
                <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
                    <h3 style="font-size: 18px; margin-bottom: 12px;">${acc.username}</h3>
                    <ul style="list-style: none; padding-left: 0;">
                        <li>‚Ä¢ <strong>–¢–µ–º–∞:</strong> ${acc.theme}</li>
                        <li>‚Ä¢ <strong>–Ø–∑—ã–∫:</strong> ${acc.language}</li>
                        <li>‚Ä¢ <strong>–ü–æ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å:</strong> ${acc.posts_per_day}</li>
                        <li>‚Ä¢ <strong>–§–æ—Ä–º–∞—Ç:</strong> ${acc.format === 'photo' ? 'üì∑ –§–æ—Ç–æ' : 'üé• –í–∏–¥–µ–æ'}</li>
                        <li>‚Ä¢ <strong>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</strong> ${acc.keywords.join(', ')}</li>
                    </ul>
                </div>
            `;
        });
        
        html += `
            <div style="text-align: center; padding-top: 20px; font-size: 18px;">
                <strong>–í—Å–µ–≥–æ –ø–æ—Å—Ç–æ–≤:</strong> ${plan.total_posts}
            </div>
        </div>`;
        
        content.innerHTML = html;
        preview.style.display = 'block';
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø—Ä–µ–≤—å—é
        preview.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function editPlan() {
        document.getElementById('planPreview').style.display = 'none';
        document.getElementById('instruction').focus();
    }
    
    async function generatePosts() {
        if (!currentPlan) {
            showToast('–ù–µ—Ç –ø–ª–∞–Ω–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', 'error');
            return;
        }
        
        // –ë–õ–û–ö–ò–†–£–ï–ú –∫–Ω–æ–ø–∫—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const generateBtn = document.getElementById('generateBtn');
        generateBtn.disabled = true;
        generateBtn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        document.getElementById('planPreview').style.display = 'none';
        document.getElementById('generationProgress').style.display = 'block';
        
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressDetails = document.getElementById('progressDetails');
        
        try {
            progressText.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞...';
            progressDetails.innerHTML = '';
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
            const data = await apiRequest('/api/ai/generate-posts', {
                method: 'POST',
                body: JSON.stringify({ plan: currentPlan })
            });
            
            // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–µ–Ω WebSocket –∏–ª–∏ polling)
            let progress = 0;
            const interval = setInterval(() => {
                progress += 5;
                if (progress >= 100) {
                    clearInterval(interval);
                    progressBar.style.width = '100%';
                    progressText.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                    progressDetails.innerHTML += `<div style="color: var(--success);">‚úÖ ${data.message}</div>`;
                    
                    setTimeout(() => {
                        showToast('–ü–æ—Å—Ç—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
                        window.location.href = '/posts';
                    }, 2000);
                } else {
                    progressBar.style.width = progress + '%';
                    progressText.textContent = `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${Math.floor(progress / 100 * currentPlan.total_posts)}/${currentPlan.total_posts} –ø–æ—Å—Ç–æ–≤`;
                    
                    if (progress % 20 === 0) {
                        progressDetails.innerHTML += `<div>‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ ${Math.floor(progress / 100 * currentPlan.total_posts)}...</div>`;
                        progressDetails.scrollTop = progressDetails.scrollHeight;
                    }
                }
            }, 500);
            
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + error.message, 'error');
            progressDetails.innerHTML += `<div style="color: var(--error);">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}
