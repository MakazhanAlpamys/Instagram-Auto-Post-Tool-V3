{% extends "base.html" %}

{% block title %}–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ - Instagram Auto Post Tool V3{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">üñºÔ∏è –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –º–µ–¥–∏–∞</h1>
    <p class="page-subtitle">–í—Å–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–∏–¥–µ–æ</p>
</div>

<div class="card">
    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="filterMedia('all')">–í—Å–µ</button>
        <button class="btn btn-secondary" onclick="filterMedia('photos')">–§–æ—Ç–æ</button>
        <button class="btn btn-secondary" onclick="filterMedia('videos')">–í–∏–¥–µ–æ</button>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;" id="mediaGrid"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
<div id="viewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; padding: 20px; overflow-y: auto;" onclick="closeViewModal()">
    <div class="card" style="max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="card-title" style="margin: 0;" id="viewTitle">–ú–µ–¥–∏–∞</h2>
            <button class="btn btn-secondary" onclick="closeViewModal()">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        
        <div id="viewContent" style="margin-bottom: 20px; max-height: 400px; overflow: hidden; border-radius: 8px;"></div>
        
        <div class="form-group">
            <label class="form-label">–ü—Ä–æ–º–ø—Ç:</label>
            <textarea class="form-textarea" id="viewPrompt" readonly style="min-height: 100px; background: var(--bg-primary);"></textarea>
        </div>
        
        <div id="viewMetadata" style="font-size: 12px; color: var(--text-secondary);"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allMedia = [];
    let currentFilter = 'all';
    
    async function loadMedia() {
        try {
            showLoading();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤
            const photosResponse = await fetch('/api/media/photos');
            const videosResponse = await fetch('/api/media/videos');
            
            if (photosResponse.ok && videosResponse.ok) {
                const photos = await photosResponse.json();
                const videos = await videosResponse.json();
                
                allMedia = [
                    ...photos.files.map(f => ({...f, type: 'photo'})),
                    ...videos.files.map(f => ({...f, type: 'video'}))
                ];
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
                allMedia.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                renderMedia();
            } else {
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞', 'error');
            }
        } catch (error) {
            console.error('Error loading media:', error);
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞', 'error');
        } finally {
            hideLoading();
        }
    }
    
    function filterMedia(filter) {
        currentFilter = filter;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.card button').forEach(btn => {
            btn.className = 'btn btn-secondary';
        });
        event.target.className = 'btn btn-primary';
        
        renderMedia();
    }
    
    function renderMedia() {
        const container = document.getElementById('mediaGrid');
        
        let filteredMedia = allMedia;
        if (currentFilter === 'photos') {
            filteredMedia = allMedia.filter(m => m.type === 'photo');
        } else if (currentFilter === 'videos') {
            filteredMedia = allMedia.filter(m => m.type === 'video');
        }
        
        if (filteredMedia.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px; grid-column: 1/-1;">–ù–µ—Ç –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤</p>';
            return;
        }
        
        container.innerHTML = filteredMedia.map(media => {
            const url = media.type === 'photo' ? `/api/photos/${media.filename}` : `/api/videos/${media.filename}`;
            const icon = media.type === 'photo' ? 'üì∑' : 'üé•';
            const preview = media.type === 'photo' 
                ? `<div style="width: 100%; height: 200px; background-image: url('${url}'); background-size: cover; background-position: center; border-radius: 8px;"></div>`
                : `<video src="${url}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px;" muted></video>`;
            
            const date = formatDateShort(media.timestamp);
            
            return `
                <div class="card" style="padding: 12px; cursor: pointer; transition: transform 0.2s;" 
                     onmouseover="this.style.transform='scale(1.05)'" 
                     onmouseout="this.style.transform='scale(1)'"
                     onclick="viewMedia('${media.filename}', '${media.type}')">
                    ${preview}
                    <div style="margin-top: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-size: 12px; font-weight: 600;">${icon} ${media.type === 'photo' ? '–§–æ—Ç–æ' : '–í–∏–¥–µ–æ'}</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">
                            üìÖ ${date}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    async function viewMedia(filename, type) {
        try {
            const url = type === 'photo' ? `/api/photos/${filename}` : `/api/videos/${filename}`;
            const metadataUrl = type === 'photo' 
                ? `/api/media/photos/${filename}/metadata`
                : `/api/media/videos/${filename}/metadata`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('viewModal').style.display = 'flex';
            document.getElementById('viewTitle').textContent = type === 'photo' ? 'üì∑ –§–æ—Ç–æ' : 'üé• –í–∏–¥–µ–æ';
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ–¥–∏–∞
            const content = document.getElementById('viewContent');
            if (type === 'photo') {
                content.innerHTML = `<img src="${url}" style="width: 100%; height: auto; max-height: 400px; object-fit: contain; border-radius: 8px;">`;
            } else {
                content.innerHTML = `<video src="${url}" controls style="width: 100%; max-height: 400px; border-radius: 8px;"></video>`;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            const metaResponse = await fetch(metadataUrl);
            if (metaResponse.ok) {
                const metadata = await metaResponse.json();
                
                document.getElementById('viewPrompt').value = metadata.prompt || '–ü—Ä–æ–º–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω';
                
                let metaHtml = `<strong>–°–æ–∑–¥–∞–Ω–æ:</strong> ${formatDate(metadata.timestamp)}<br>`;
                if (type === 'photo') {
                    metaHtml += `<strong>–ú–æ–¥–µ–ª—å:</strong> ${metadata.model || 'N/A'}<br>`;
                    metaHtml += `<strong>–†–∞–∑–º–µ—Ä:</strong> ${metadata.width}x${metadata.height}px`;
                } else {
                    metaHtml += `<strong>–ú–æ–¥–µ–ª—å:</strong> ${metadata.model || 'N/A'}<br>`;
                    metaHtml += `<strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${metadata.duration || 'N/A'} —Å–µ–∫<br>`;
                    metaHtml += `<strong>–†–µ–∂–∏–º:</strong> ${metadata.mode || 'N/A'}`;
                }
                
                document.getElementById('viewMetadata').innerHTML = metaHtml;
            } else {
                document.getElementById('viewPrompt').value = '–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                document.getElementById('viewMetadata').innerHTML = '';
            }
            
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏', 'error');
        }
    }
    
    function closeViewModal() {
        document.getElementById('viewModal').style.display = 'none';
    }
    
    function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        try {
            // –ü–∞—Ä—Å–∏–º —Ñ–æ—Ä–º–∞—Ç: 20251025_122147_677059
            const dateStr = timestamp.substring(0, 8); // 20251025
            const timeStr = timestamp.substring(9, 15); // 122147
            
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);
            const hour = timeStr.substring(0, 2);
            const minute = timeStr.substring(2, 4);
            
            return `${day}.${month}.${year} ${hour}:${minute}`;
        } catch (e) {
            return 'N/A';
        }
    }
    
    function formatDateShort(timestamp) {
        if (!timestamp) return 'N/A';
        try {
            // –ü–∞—Ä—Å–∏–º —Ñ–æ—Ä–º–∞—Ç: 20251025_122147_677059
            const dateStr = timestamp.substring(0, 8); // 20251025
            const timeStr = timestamp.substring(9, 15); // 122147
            
            const day = dateStr.substring(6, 8);
            const month = dateStr.substring(4, 6);
            const hour = timeStr.substring(0, 2);
            const minute = timeStr.substring(2, 4);
            
            return `${day}.${month} ${hour}:${minute}`;
        } catch (e) {
            return 'N/A';
        }
    }
    
    loadMedia();
</script>
{% endblock %}
