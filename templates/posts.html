{% extends "base.html" %}

{% block title %}–ü–æ—Å—Ç—ã - Instagram Auto Post Tool V3{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">–ü–æ—Å—Ç—ã</h1>
    <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞–º–∏, –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–º–∏</p>
</div>

<div class="card">
    <div style="display: flex; gap: 12px; margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="filterPosts('all')">–í—Å–µ</button>
        <button class="btn btn-secondary" onclick="filterPosts('draft')">–ß–µ—Ä–Ω–æ–≤–∏–∫–∏</button>
        <button class="btn btn-secondary" onclick="filterPosts('scheduled')">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã</button>
        <button class="btn btn-secondary" onclick="filterPosts('published')">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã</button>
    </div>
    
    <div id="postsList"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto; padding: 20px;">
    <div class="card" style="width: 700px; max-width: 100%; margin: auto;">
        <h2 class="card-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞</h2>
        
        <div class="form-group">
            <label class="form-label">–ú–µ–¥–∏–∞ (—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ)</label>
            <div id="editImagePreview" style="width: 100%; height: 300px; background: var(--bg-tertiary); border-radius: 8px; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; overflow: hidden;"></div>
        </div>
        
        <div class="form-group">
            <label class="form-label">–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞</label>
            <textarea class="form-textarea" id="editText" style="min-height: 200px;"></textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">–í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
            <input type="datetime-local" class="form-input" id="editScheduledTime">
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button class="btn btn-primary" onclick="savePost()" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-success" onclick="publishPostNow()" id="publishNowBtn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å</button>
            <button class="btn btn-secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allPosts = [];
    let currentFilter = 'all';
    let editingPostId = null;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –º–µ–¥–∏–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
    function getMediaUrl(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        if (['mp4', 'mov', 'avi', 'webm'].includes(ext)) {
            return `/api/videos/${filename}`;
        }
        return `/api/photos/${filename}`;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–¥–∏–∞ (—Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ)
    function getMediaDisplay(filename, format) {
        const ext = filename.split('.').pop().toLowerCase();
        if (['mp4', 'mov', 'avi', 'webm'].includes(ext)) {
            return ''; // –î–ª—è –≤–∏–¥–µ–æ –Ω–µ –Ω—É–∂–µ–Ω background-image
        }
        return `background-image: url('${getMediaUrl(filename)}'); background-size: cover; background-position: center;`;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –º–µ–¥–∏–∞
    function getMediaElement(filename, format) {
        const ext = filename.split('.').pop().toLowerCase();
        if (['mp4', 'mov', 'avi', 'webm'].includes(ext)) {
            return `<video src="${getMediaUrl(filename)}" style="width: 100%; height: 100%; object-fit: cover;" muted loop autoplay></video>`;
        }
        return ''; // –î–ª—è —Ñ–æ—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º background-image
    }
    
    async function loadPosts(status = null) {
        try {
            const url = status ? `/api/posts?status=${status}` : '/api/posts';
            const data = await apiRequest(url);
            allPosts = data.posts;
            renderPosts();
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤: ' + error.message, 'error');
        }
    }
    
    function filterPosts(filter) {
        currentFilter = filter;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.querySelectorAll('.card button').forEach(btn => {
            btn.className = 'btn btn-secondary';
        });
        event.target.className = 'btn btn-primary';
        
        if (filter === 'all') {
            loadPosts();
        } else {
            loadPosts(filter);
        }
    }
    
    function renderPosts() {
        const container = document.getElementById('postsList');
        
        if (allPosts.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</p>';
            return;
        }
        
        container.innerHTML = allPosts.map(post => {
            const statusColor = {
                'draft': 'var(--text-secondary)',
                'scheduled': 'var(--warning)',
                'published': 'var(--success)',
                'error': 'var(--error)'
            }[post.status];
            
            const statusText = {
                'draft': 'üìù –ß–µ—Ä–Ω–æ–≤–∏–∫',
                'scheduled': 'üü° –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω',
                'published': 'üü¢ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω',
                'error': '‚ùå –û—à–∏–±–∫–∞'
            }[post.status];
            
            const timeText = post.status === 'scheduled' 
                ? `–Ω–∞ ${new Date(post.scheduled_time).toLocaleString('ru-RU')}`
                : post.status === 'published'
                ? `–≤ ${new Date(post.published_at).toLocaleString('ru-RU')}`
                : '';
            
            return `
                <div class="card" style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 20px;">
                        <div style="width: 150px; height: 150px; background: var(--bg-tertiary); border-radius: 8px; ${getMediaDisplay(post.media[0], post.format)} flex-shrink: 0; position: relative; overflow: hidden;">
                            ${getMediaElement(post.media[0], post.format)}
                        </div>
                        
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <div style="color: ${statusColor}; font-weight: 600; margin-bottom: 4px;">
                                        ${statusText} ${timeText}
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">
                                        –°–æ–∑–¥–∞–Ω–æ: ${new Date(post.created_at).toLocaleString('ru-RU')}
                                    </div>
                                </div>
                            </div>
                            
                            <p style="color: var(--text-secondary); font-size: 14px; line-height: 1.6; margin-bottom: 12px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">
                                ${post.text}
                            </p>
                            
                            ${post.status === 'error' ? `
                                <div style="color: var(--error); font-size: 12px; padding: 8px; background: rgba(255,59,48,0.1); border-radius: 4px; margin-bottom: 12px;">
                                    –û—à–∏–±–∫–∞: ${post.error}
                                </div>
                            ` : ''}
                            
                            <div style="display: flex; gap: 8px;">
                                ${post.status !== 'published' ? `
                                    <button class="btn btn-primary" onclick="editPost('${post.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                ` : `
                                    <button class="btn btn-secondary" onclick="viewPost('${post.id}')">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                                `}
                                <button class="btn btn-danger" onclick="confirmDeletePost('${post.id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    async function editPost(postId) {
        try {
            const data = await apiRequest(`/api/posts/${postId}`);
            const post = data.post;
            
            editingPostId = postId;
            
            document.getElementById('editText').value = post.text;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–¥–∏–∞ (—Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ)
            const preview = document.getElementById('editImagePreview');
            const filename = post.media[0];
            const ext = filename.split('.').pop().toLowerCase();
            
            if (['mp4', 'mov', 'avi', 'webm'].includes(ext)) {
                // –í–∏–¥–µ–æ
                preview.style.backgroundImage = 'none';
                preview.innerHTML = `<video src="${getMediaUrl(filename)}" style="width: 100%; height: 100%; object-fit: contain;" controls></video>`;
            } else {
                // –§–æ—Ç–æ
                preview.innerHTML = '';
                preview.style.backgroundImage = `url('${getMediaUrl(filename)}')`;
            }
            
            if (post.scheduled_time) {
                const date = new Date(post.scheduled_time);
                document.getElementById('editScheduledTime').value = date.toISOString().slice(0, 16);
            }
            
            document.getElementById('editModal').style.display = 'flex';
            
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        }
    }
    
    function viewPost(postId) {
        editPost(postId);
        // –î–µ–ª–∞–µ–º –≤—Å–µ –ø–æ–ª—è —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
        document.getElementById('editText').disabled = true;
        document.querySelectorAll('#editModal .btn-primary, #editModal .btn-danger').forEach(btn => {
            btn.style.display = 'none';
        });
    }
    
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
        document.getElementById('editText').disabled = false;
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        const saveBtn = document.getElementById('saveBtn');
        const publishBtn = document.getElementById('publishNowBtn');
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
        if (publishBtn) {
            publishBtn.disabled = false;
            publishBtn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å';
        }
        
        editingPostId = null;
    }
    
    async function savePost() {
        if (!editingPostId) return;
        
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        try {
            const scheduledTimeInput = document.getElementById('editScheduledTime').value;
            
            const updates = {
                text: document.getElementById('editText').value,
                scheduled_time: scheduledTimeInput || null
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ scheduled –µ—Å–ª–∏ –∑–∞–¥–∞–Ω–æ –≤—Ä–µ–º—è
            if (scheduledTimeInput) {
                updates.status = 'scheduled';
            }
            
            await apiRequest(`/api/posts/${editingPostId}`, {
                method: 'PUT',
                body: JSON.stringify(updates)
            });
            
            showToast('–ü–æ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            closeEditModal();
            loadPosts(currentFilter === 'all' ? null : currentFilter);
            
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
    }
    
    async function publishPostNow() {
        if (!editingPostId) return;
        
        if (!confirm('–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å?')) return;
        
        const publishBtn = document.getElementById('publishNowBtn');
        publishBtn.disabled = true;
        publishBtn.textContent = 'üîÑ –ü—É–±–ª–∏–∫–∞—Ü–∏—è...';
        
        try {
            await apiRequest(`/api/posts/${editingPostId}/publish-now`, { method: 'POST' });
            showToast('–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!', 'success');
            closeEditModal();
            loadPosts(currentFilter === 'all' ? null : currentFilter);
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + error.message, 'error');
        } finally {
            publishBtn.disabled = false;
            publishBtn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–µ–π—á–∞—Å';
        }
    }
    
    async function confirmDeletePost(postId) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return;
        
        showLoading();
        
        try {
            await apiRequest(`/api/posts/${postId}`, { method: 'DELETE' });
            showToast('–ü–æ—Å—Ç —É–¥–∞–ª–µ–Ω', 'success');
            
            if (editingPostId === postId) {
                closeEditModal();
            }
            
            loadPosts(currentFilter === 'all' ? null : currentFilter);
        } catch (error) {
            showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    
    loadPosts();
</script>
{% endblock %}
